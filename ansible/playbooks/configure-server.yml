---
- name: Configurar servidor web completo en AWS
  hosts: webservers
  become: yes
  gather_facts: yes
  
  vars:
    # Variables por defecto que pueden ser sobrescritas
    system_timezone: "America/Mexico_City"
    nginx_server_name: "{{ ansible_default_ipv4.address }}"
    nginx_worker_connections: 1024
    nginx_keepalive_timeout: 65
    nginx_server_tokens: "off"
    enable_nginx_status: false
    
    # Lista de puertos adicionales a abrir (opcional)
    # additional_open_ports:
    #   - "8080"
    #   - "3000"
    
    # Lista de usuarios del sistema (opcional)
    # system_users:
    #   - name: developer
    #     groups: sudo,www-data
    #     ssh_keys:
    #       - developer.pub
    #   - name: devops
    #     groups: sudo
    #     ssh_keys:
    #       - devops.pub

  pre_tasks:
    - name: Mostrar información del servidor
      debug:
        msg: 
          - "Configurando servidor: {{ ansible_hostname }}"
          - "IP: {{ ansible_default_ipv4.address }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "Arquitectura: {{ ansible_architecture }}"
      tags: always

    - name: Verificar conectividad y permisos
      ping:
      tags: always

  roles:
    - role: common
      tags:
        - common
        - base
        - security
    
    - role: nginx
      tags:
        - nginx
        - web
        - application

  post_tasks:
    - name: Verificar que los servicios estén ejecutándose
      service_facts:
      tags: validation

    - name: Mostrar estado de servicios críticos
      debug:
        msg: "{{ item }} está {{ ansible_facts.services[item + '.service'].state }}"
      loop:
        - nginx
        - fail2ban
        - ufw
      when: ansible_facts.services[item + '.service'] is defined
      tags: validation

    - name: Realizar prueba HTTP básica
      uri:
        url: "http://{{ ansible_default_ipv4.address }}"
        method: GET
        status_code: 200
      register: http_test
      ignore_errors: yes
      tags: validation

    - name: Mostrar resultado de prueba HTTP
      debug:
        msg: 
          - "Prueba HTTP: {{ 'EXITOSA' if http_test.status == 200 else 'FALLÓ' }}"
          - "Puedes acceder a tu servidor en: http://{{ ansible_default_ipv4.address }}"
      tags: validation

    - name: Resumen de configuración completada
      debug:
        msg:
          - "🎉 ¡Configuración completada exitosamente!"
          - "📊 Servidor: {{ ansible_hostname }} ({{ ansible_default_ipv4.address }})"
          - "🔧 Roles aplicados: common, nginx"
          - "🔒 Firewall: UFW habilitado"
          - "🛡️  Seguridad: fail2ban activo"
          - "🌐 Web: Nginx ejecutándose en puerto 80"
          - "🔗 URL: http://{{ ansible_default_ipv4.address }}"
      tags: always
